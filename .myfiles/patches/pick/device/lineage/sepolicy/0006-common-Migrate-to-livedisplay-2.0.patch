From 33173af41dc151a6c4cbf1ef7e3d79e75805ac1d Mon Sep 17 00:00:00 2001
From: Bruno Martins <bgcngm@gmail.com>
Date: Mon, 21 Jan 2019 10:10:45 +0000
Subject: [PATCH 6/6] common: Migrate to livedisplay 2.0

Change-Id: Ib67bf7fb29b202c031a2ad3556596a8b91fd5d54
---
 common/private/file.te                   |  1 -
 common/private/genfs_contexts            |  8 --------
 common/public/file.te                    |  2 ++
 common/vendor/file_contexts              |  4 ++--
 common/vendor/genfs_contexts             |  7 +++++++
 common/vendor/hal_livedisplay_default.te |  3 +++
 common/vendor/hwservice_contexts         | 10 +++++++++-
 common/vendor/platform_app.te            |  1 +
 common/vendor/system_app.te              |  4 ++++
 9 files changed, 28 insertions(+), 12 deletions(-)
 create mode 100644 common/public/file.te
 create mode 100644 common/vendor/genfs_contexts
 create mode 100644 common/vendor/platform_app.te

diff --git a/common/private/file.te b/common/private/file.te
index 7a47d08..c039f4a 100644
--- a/common/private/file.te
+++ b/common/private/file.te
@@ -1,2 +1 @@
 type sysfs_io_sched_tuneable, fs_type, sysfs_type;
-type sysfs_livedisplay_tuneable, fs_type, sysfs_type;
diff --git a/common/private/genfs_contexts b/common/private/genfs_contexts
index eed7a2d..97887b9 100644
--- a/common/private/genfs_contexts
+++ b/common/private/genfs_contexts
@@ -1,12 +1,4 @@
 genfscon fuseblk / u:object_r:vfat:s0
 genfscon sdfat / u:object_r:exfat:s0
 
-genfscon sysfs /devices/virtual/graphics/fb0/aco u:object_r:sysfs_livedisplay_tuneable:s0
-genfscon sysfs /devices/virtual/graphics/fb0/cabc u:object_r:sysfs_livedisplay_tuneable:s0
-genfscon sysfs /devices/virtual/graphics/fb0/color_enhance u:object_r:sysfs_livedisplay_tuneable:s0
-genfscon sysfs /devices/virtual/graphics/fb0/hbm u:object_r:sysfs_livedisplay_tuneable:s0
-genfscon sysfs /devices/virtual/graphics/fb0/rgb u:object_r:sysfs_livedisplay_tuneable:s0
-genfscon sysfs /devices/virtual/graphics/fb0/sre u:object_r:sysfs_livedisplay_tuneable:s0
-genfscon sysfs /devices/virtual/graphics/fb0/reading_mode u:object_r:sysfs_livedisplay_tuneable:s0
-
 genfscon sysfs /devices/virtual/timed_output/vibrator u:object_r:sysfs_vibrator:s0
diff --git a/common/public/file.te b/common/public/file.te
new file mode 100644
index 0000000..21bd97d
--- /dev/null
+++ b/common/public/file.te
@@ -0,0 +1,2 @@
+# LiveDisplay tuneables
+type sysfs_livedisplay_tuneable, fs_type, sysfs_type;
diff --git a/common/vendor/file_contexts b/common/vendor/file_contexts
index 9f9228e..46c9a2a 100644
--- a/common/vendor/file_contexts
+++ b/common/vendor/file_contexts
@@ -5,8 +5,8 @@
 /(vendor|system/vendor)/bin/hw/android\.hardware\.light@2\.0-service\.aw2013 u:object_r:hal_light_default_exec:s0
 
 # LiveDisplay HAL
-/(vendor|system/vendor)/bin/hw/vendor\.lineage\.livedisplay@1\.0-service-legacymm u:object_r:hal_livedisplay_default_exec:s0
-/(vendor|system/vendor)/bin/hw/vendor\.lineage\.livedisplay@1\.0-service-sdm u:object_r:hal_livedisplay_default_exec:s0
+/(vendor|system/vendor)/bin/hw/vendor\.lineage\.livedisplay@2\.0-service-legacymm u:object_r:hal_livedisplay_default_exec:s0
+/(vendor|system/vendor)/bin/hw/vendor\.lineage\.livedisplay@2\.0-service-sdm u:object_r:hal_livedisplay_default_exec:s0
 
 # Trust HAL
 /(vendor|system/vendor)/bin/hw/vendor\.lineage\.trust@1\.0-service u:object_r:hal_trust_default_exec:s0
diff --git a/common/vendor/genfs_contexts b/common/vendor/genfs_contexts
new file mode 100644
index 0000000..6950f3c
--- /dev/null
+++ b/common/vendor/genfs_contexts
@@ -0,0 +1,7 @@
+genfscon sysfs /devices/virtual/graphics/fb0/aco              u:object_r:sysfs_livedisplay_tuneable:s0
+genfscon sysfs /devices/virtual/graphics/fb0/cabc             u:object_r:sysfs_livedisplay_tuneable:s0
+genfscon sysfs /devices/virtual/graphics/fb0/color_enhance    u:object_r:sysfs_livedisplay_tuneable:s0
+genfscon sysfs /devices/virtual/graphics/fb0/hbm              u:object_r:sysfs_livedisplay_tuneable:s0
+genfscon sysfs /devices/virtual/graphics/fb0/rgb              u:object_r:sysfs_livedisplay_tuneable:s0
+genfscon sysfs /devices/virtual/graphics/fb0/sre              u:object_r:sysfs_livedisplay_tuneable:s0
+genfscon sysfs /devices/virtual/graphics/fb0/reading_mode     u:object_r:sysfs_livedisplay_tuneable:s0
diff --git a/common/vendor/hal_livedisplay_default.te b/common/vendor/hal_livedisplay_default.te
index 874d446..1666903 100644
--- a/common/vendor/hal_livedisplay_default.te
+++ b/common/vendor/hal_livedisplay_default.te
@@ -10,3 +10,6 @@ get_prop(hal_livedisplay_default, hwservicemanager_prop)
 
 # Add vendor.lineage.livedisplay::IColor service to hwservicemanager
 add_hwservice(hal_livedisplay_default, hal_lineage_livedisplay_hwservice)
+
+# Grant access over LiveDisplay tuneables
+allow hal_livedisplay_default sysfs_livedisplay_tuneable:file rw_file_perms;
diff --git a/common/vendor/hwservice_contexts b/common/vendor/hwservice_contexts
index dcb21ab..dcf0728 100644
--- a/common/vendor/hwservice_contexts
+++ b/common/vendor/hwservice_contexts
@@ -1,4 +1,12 @@
-vendor.lineage.livedisplay::IColor       u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IAdaptiveBacklight       u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IAutoContrast            u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IColorBalance            u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IColorEnhancement        u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IDisplayColorCalibration u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IDisplayModes            u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IPictureAdjustment       u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IReadingEnhancement      u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::ISunlightEnhancement     u:object_r:hal_lineage_livedisplay_hwservice:s0
 
 vendor.lineage.power::ILineagePower      u:object_r:hal_lineage_power_hwservice:s0
 
diff --git a/common/vendor/platform_app.te b/common/vendor/platform_app.te
new file mode 100644
index 0000000..df9b424
--- /dev/null
+++ b/common/vendor/platform_app.te
@@ -0,0 +1 @@
+allow platform_app hal_lineage_livedisplay_hwservice:hwservice_manager find;
diff --git a/common/vendor/system_app.te b/common/vendor/system_app.te
index 5eabb10..8ec1982 100644
--- a/common/vendor/system_app.te
+++ b/common/vendor/system_app.te
@@ -1,3 +1,7 @@
+binder_call(system_app, hal_livedisplay_default)
+
+allow system_app hal_lineage_livedisplay_hwservice:hwservice_manager find;
+
 binder_call(system_app, hal_lineage_touch_default)
 
 allow system_app hal_lineage_touch_hwservice:hwservice_manager find;
-- 
2.17.1

