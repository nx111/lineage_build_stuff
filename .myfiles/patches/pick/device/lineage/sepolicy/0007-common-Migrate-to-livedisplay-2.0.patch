From 4c4633795538202eafae416174a860766c380564 Mon Sep 17 00:00:00 2001
From: Bruno Martins <bgcngm@gmail.com>
Date: Mon, 21 Jan 2019 10:10:45 +0000
Subject: [PATCH 7/7] common: Migrate to livedisplay 2.0

Change-Id: Ib67bf7fb29b202c031a2ad3556596a8b91fd5d54
---
 common/private/file.te                   |  1 -
 common/private/hwservice_contexts        | 10 +++++++++-
 common/private/platform_app.te           |  3 +++
 common/private/system_app.te             |  3 +++
 common/public/file.te                    |  3 +++
 common/public/hal_lineage_livedisplay.te |  3 +++
 common/vendor/file_contexts              |  4 ++--
 7 files changed, 23 insertions(+), 4 deletions(-)

diff --git a/common/private/file.te b/common/private/file.te
index 7a47d08..c039f4a 100644
--- a/common/private/file.te
+++ b/common/private/file.te
@@ -1,2 +1 @@
 type sysfs_io_sched_tuneable, fs_type, sysfs_type;
-type sysfs_livedisplay_tuneable, fs_type, sysfs_type;
diff --git a/common/private/hwservice_contexts b/common/private/hwservice_contexts
index 1c1f3de..b6dd0a3 100644
--- a/common/private/hwservice_contexts
+++ b/common/private/hwservice_contexts
@@ -1,3 +1,11 @@
-vendor.lineage.livedisplay::IColor                   u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IAdaptiveBacklight       u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IAutoContrast            u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IColorBalance            u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IColorEnhancement        u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IDisplayColorCalibration u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IDisplayModes            u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IPictureAdjustment       u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::IReadingEnhancement      u:object_r:hal_lineage_livedisplay_hwservice:s0
+vendor.lineage.livedisplay::ISunlightEnhancement     u:object_r:hal_lineage_livedisplay_hwservice:s0
 vendor.lineage.power::ILineagePower                  u:object_r:hal_power_hwservice:s0
 vendor.lineage.trust::IUsbRestrict                   u:object_r:hal_lineage_trust_hwservice:s0
diff --git a/common/private/platform_app.te b/common/private/platform_app.te
index abb1ebc..d5bfd72 100644
--- a/common/private/platform_app.te
+++ b/common/private/platform_app.te
@@ -1,2 +1,5 @@
 # Allow NFC service to be found
 allow platform_app nfc_service:service_manager find;
+
+# Allow LiveDisplay HAL service to be found
+allow platform_app hal_lineage_livedisplay_hwservice:hwservice_manager find;
diff --git a/common/private/system_app.te b/common/private/system_app.te
index e2c1f4b..9b128ec 100644
--- a/common/private/system_app.te
+++ b/common/private/system_app.te
@@ -4,3 +4,6 @@ allow system_app cache_recovery_file:file {create rw_file_perms};
 
 # Allow Settings to read ro.vendor.build.security_patch
 get_prop(system_app, vendor_security_patch_level_prop)
+
+# Allow access to the HALs
+hal_client_domain(system_app, hal_lineage_livedisplay)
diff --git a/common/public/file.te b/common/public/file.te
index e68493d..6a6d34f 100644
--- a/common/public/file.te
+++ b/common/public/file.te
@@ -1 +1,4 @@
 type hal_lineage_trust_file, file_type, fs_type, proc_type;
+
+# LiveDisplay tuneables
+type sysfs_livedisplay_tuneable, fs_type, sysfs_type;
diff --git a/common/public/hal_lineage_livedisplay.te b/common/public/hal_lineage_livedisplay.te
index 6a9aac5..938b3ee 100644
--- a/common/public/hal_lineage_livedisplay.te
+++ b/common/public/hal_lineage_livedisplay.te
@@ -3,3 +3,6 @@ binder_call(hal_lineage_livedisplay_client, hal_lineage_livedisplay_server)
 
 add_hwservice(hal_lineage_livedisplay_server, hal_lineage_livedisplay_hwservice)
 allow hal_lineage_livedisplay_client hal_lineage_livedisplay_hwservice:hwservice_manager find;
+
+# Grant access over LiveDisplay tuneables
+allow hal_lineage_livedisplay sysfs_livedisplay_tuneable:file rw_file_perms;
diff --git a/common/vendor/file_contexts b/common/vendor/file_contexts
index 30f6006..89b5264 100644
--- a/common/vendor/file_contexts
+++ b/common/vendor/file_contexts
@@ -5,8 +5,8 @@
 /(vendor|system/vendor)/bin/hw/android\.hardware\.light@2\.0-service\.aw2013 u:object_r:hal_light_default_exec:s0
 
 # LiveDisplay HAL
-/(vendor|system/vendor)/bin/hw/vendor\.lineage\.livedisplay@1\.0-service-legacymm u:object_r:hal_lineage_livedisplay_default_exec:s0
-/(vendor|system/vendor)/bin/hw/vendor\.lineage\.livedisplay@1\.0-service-sdm u:object_r:hal_lineage_livedisplay_default_exec:s0
+/(vendor|system/vendor)/bin/hw/vendor\.lineage\.livedisplay@2\.0-service-legacymm u:object_r:hal_lineage_livedisplay_default_exec:s0
+/(vendor|system/vendor)/bin/hw/vendor\.lineage\.livedisplay@2\.0-service-sdm u:object_r:hal_lineage_livedisplay_default_exec:s0
 
 # Trust HAL
 /(vendor|system/vendor)/bin/hw/vendor\.lineage\.trust@1\.0-service u:object_r:hal_lineage_trust_default_exec:s0
-- 
2.17.1

