From f0c72131273f8157a9e45f65cc1445452adce20b Mon Sep 17 00:00:00 2001
From: Joey <joey@lineageos.org>
Date: Wed, 9 Jan 2019 22:24:44 +0100
Subject: [PATCH 4/7] sepolicies: add Trust hal

Change-Id: I32f488801bae780ab9d22762ff91d199160f717a
Signed-off-by: Joey <joey@lineageos.org>
---
 common/private/genfs_contexts              | 2 ++
 common/private/hwservice_contexts          | 1 +
 common/private/system_server.te            | 1 +
 common/public/attributes                   | 1 +
 common/public/file.te                      | 1 +
 common/public/hal_lineage_trust.te         | 9 +++++++++
 common/public/hwservice.te                 | 1 +
 common/vendor/file_contexts                | 3 +++
 common/vendor/hal_lineage_trust_default.te | 5 +++++
 9 files changed, 24 insertions(+)
 create mode 100644 common/public/file.te
 create mode 100644 common/public/hal_lineage_trust.te
 create mode 100644 common/vendor/hal_lineage_trust_default.te

diff --git a/common/private/genfs_contexts b/common/private/genfs_contexts
index eed7a2d..f06eddd 100644
--- a/common/private/genfs_contexts
+++ b/common/private/genfs_contexts
@@ -10,3 +10,5 @@ genfscon sysfs /devices/virtual/graphics/fb0/sre u:object_r:sysfs_livedisplay_tu
 genfscon sysfs /devices/virtual/graphics/fb0/reading_mode u:object_r:sysfs_livedisplay_tuneable:s0
 
 genfscon sysfs /devices/virtual/timed_output/vibrator u:object_r:sysfs_vibrator:s0
+
+genfscon proc /sys/kernel/deny_new_usb u:object_r:hal_lineage_trust_file:s0
diff --git a/common/private/hwservice_contexts b/common/private/hwservice_contexts
index ca6c2b6..1c1f3de 100644
--- a/common/private/hwservice_contexts
+++ b/common/private/hwservice_contexts
@@ -1,2 +1,3 @@
 vendor.lineage.livedisplay::IColor                   u:object_r:hal_lineage_livedisplay_hwservice:s0
 vendor.lineage.power::ILineagePower                  u:object_r:hal_power_hwservice:s0
+vendor.lineage.trust::IUsbRestrict                   u:object_r:hal_lineage_trust_hwservice:s0
diff --git a/common/private/system_server.te b/common/private/system_server.te
index 9d7a8c6..af2c520 100644
--- a/common/private/system_server.te
+++ b/common/private/system_server.te
@@ -5,3 +5,4 @@ allow system_server sysfs_livedisplay_tuneable:file rw_file_perms;
 
 # Use HALs
 hal_client_domain(system_server, hal_lineage_livedisplay)
+hal_client_domain(system_server, hal_lineage_trust)
diff --git a/common/public/attributes b/common/public/attributes
index 785e7dd..47c2238 100644
--- a/common/public/attributes
+++ b/common/public/attributes
@@ -1,2 +1,3 @@
 # HALs
 hal_attribute(lineage_livedisplay)
+hal_attribute(lineage_trust)
diff --git a/common/public/file.te b/common/public/file.te
new file mode 100644
index 0000000..e68493d
--- /dev/null
+++ b/common/public/file.te
@@ -0,0 +1 @@
+type hal_lineage_trust_file, file_type, fs_type, proc_type;
diff --git a/common/public/hal_lineage_trust.te b/common/public/hal_lineage_trust.te
new file mode 100644
index 0000000..710c28d
--- /dev/null
+++ b/common/public/hal_lineage_trust.te
@@ -0,0 +1,9 @@
+# HwBinder IPC from client to server
+binder_call(hal_lineage_trust_client, hal_lineage_trust_server)
+
+add_hwservice(hal_lineage_trust_server, hal_lineage_trust_hwservice)
+allow hal_lineage_trust_client hal_lineage_trust_hwservice:hwservice_manager find;
+
+allow hal_lineage_trust self:capability sys_admin;
+
+allow hal_lineage_trust hal_lineage_trust_file:file rw_file_perms;
diff --git a/common/public/hwservice.te b/common/public/hwservice.te
index fb4890c..e5b0751 100644
--- a/common/public/hwservice.te
+++ b/common/public/hwservice.te
@@ -1 +1,2 @@
 type hal_lineage_livedisplay_hwservice, hwservice_manager_type;
+type hal_lineage_trust_hwservice, hwservice_manager_type;
diff --git a/common/vendor/file_contexts b/common/vendor/file_contexts
index dcca85a..30f6006 100644
--- a/common/vendor/file_contexts
+++ b/common/vendor/file_contexts
@@ -8,6 +8,9 @@
 /(vendor|system/vendor)/bin/hw/vendor\.lineage\.livedisplay@1\.0-service-legacymm u:object_r:hal_lineage_livedisplay_default_exec:s0
 /(vendor|system/vendor)/bin/hw/vendor\.lineage\.livedisplay@1\.0-service-sdm u:object_r:hal_lineage_livedisplay_default_exec:s0
 
+# Trust HAL
+/(vendor|system/vendor)/bin/hw/vendor\.lineage\.trust@1\.0-service u:object_r:hal_lineage_trust_default_exec:s0
+
 # USB HAL
 /(vendor|system/vendor)/bin/hw/android\.hardware\.usb@1\.0-service\.basic u:object_r:hal_usb_default_exec:s0
 
diff --git a/common/vendor/hal_lineage_trust_default.te b/common/vendor/hal_lineage_trust_default.te
new file mode 100644
index 0000000..2afad88
--- /dev/null
+++ b/common/vendor/hal_lineage_trust_default.te
@@ -0,0 +1,5 @@
+type hal_lineage_trust_default, domain;
+hal_server_domain(hal_lineage_trust_default, hal_lineage_trust)
+
+type hal_lineage_trust_default_exec, exec_type, vendor_file_type, file_type;
+init_daemon_domain(hal_lineage_trust_default)
-- 
2.17.1

