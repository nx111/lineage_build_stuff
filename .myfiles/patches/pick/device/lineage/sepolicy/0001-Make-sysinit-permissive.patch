From d17608cbb036c1c62047eff6b99b3d16f63aea1a Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Sun, 3 Feb 2019 12:34:15 +0100
Subject: [PATCH 1/5] Make sysinit permissive

* It triggers too many neverallows

Change-Id: Ied62423d7d081cda9c97d7b824373084027f506c
---
 common/private/file_contexts |  4 ----
 common/private/sysinit.te    | 15 ++-------------
 common/private/userinit.te   |  4 ----
 3 files changed, 2 insertions(+), 21 deletions(-)
 delete mode 100644 common/private/userinit.te

diff --git a/common/private/file_contexts b/common/private/file_contexts
index 55b64ba..e02958a 100644
--- a/common/private/file_contexts
+++ b/common/private/file_contexts
@@ -24,7 +24,3 @@
 
 # Sysinit
 /system/bin/sysinit                     u:object_r:sysinit_exec:s0
-
-# Userinit
-/data/local/userinit\.sh                u:object_r:userinit_data_exec:s0
-/system/etc/init\.d/90userinit          u:object_r:userinit_exec:s0
diff --git a/common/private/sysinit.te b/common/private/sysinit.te
index 1b9c89d..7a584d5 100644
--- a/common/private/sysinit.te
+++ b/common/private/sysinit.te
@@ -3,19 +3,8 @@ type sysinit_exec, exec_type, file_type;
 
 # Allow for transition from init domain to sysinit
 init_daemon_domain(sysinit)
-
-allow sysinit devpts:chr_file rw_file_perms;
-allow sysinit self:process setcurrent;
-allow sysinit shell_exec:file rx_file_perms;
-allow sysinit system_file:dir r_dir_perms;
-allow sysinit system_file:file rx_file_perms;
-allow sysinit toolbox_exec:file rx_file_perms;
+neverallow { domain -init } sysinit:process transition;
 
 userdebug_or_eng(`
-    allow sysinit userinit_data_exec:file { r_file_perms relabelto };
-    allow sysinit sysfs:file rw_file_perms;
-    allow sysinit sysfs_devices_system_cpu:file write;
-    allow sysinit self:capability dac_override;
-    allow sysinit userinit_exec:file rx_file_perms;
-    set_prop(sysinit, userinit_prop)
+    permissive sysinit;
 ')
diff --git a/common/private/userinit.te b/common/private/userinit.te
deleted file mode 100644
index 48a4891..0000000
--- a/common/private/userinit.te
+++ /dev/null
@@ -1,4 +0,0 @@
-type userinit_exec, exec_type, file_type;
-type userinit_data_exec, file_type, data_file_type;
-
-set_prop(userinit_exec, userinit_prop)
-- 
2.17.1

