From 05e69baedac1f4ec1130435d1ebd45ee946862db Mon Sep 17 00:00:00 2001
From: Joey <joey@lineageos.org>
Date: Sun, 29 Jul 2018 15:32:11 +0200
Subject: [PATCH 1/2] Eleven: bump to api26

Change-Id: Ib2099cf0852ce2194fbd1058ab74c0710746c7d8
Signed-off-by: Joey <joey@lineageos.org>
---
 AndroidManifest.xml                           |  2 +-
 res/values/strings.xml                        |  2 ++
 .../eleven/MusicPlaybackService.java          | 24 ++++++++++++++++++-
 3 files changed, 26 insertions(+), 2 deletions(-)

diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 164b327..67bb8bc 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -21,7 +21,7 @@
 
     <uses-sdk
         android:minSdkVersion="24"
-        android:targetSdkVersion="24" />
+        android:targetSdkVersion="26" />
 
     <original-package android:name="com.cyanogenmod.eleven" />
 
diff --git a/res/values/strings.xml b/res/values/strings.xml
index 7e96954..605dd8e 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -207,4 +207,6 @@
     <string name="search_title_playlists">All \"%s\" playlists</string>
 
     <string name="duration_format"><xliff:g id="hours">%1$s</xliff:g> <xliff:g id="minutes">%2$s</xliff:g></string>
+
+    <string name="channel_music">Music playback</string>
 </resources>
diff --git a/src/org/lineageos/eleven/MusicPlaybackService.java b/src/org/lineageos/eleven/MusicPlaybackService.java
index 312b788..9b8d77a 100644
--- a/src/org/lineageos/eleven/MusicPlaybackService.java
+++ b/src/org/lineageos/eleven/MusicPlaybackService.java
@@ -18,6 +18,7 @@ import android.annotation.NonNull;
 import android.annotation.SuppressLint;
 import android.app.AlarmManager;
 import android.app.Notification;
+import android.app.NotificationChannel;
 import android.app.NotificationManager;
 import android.app.PendingIntent;
 import android.app.Service;
@@ -56,6 +57,7 @@ import android.os.SystemClock;
 import android.provider.MediaStore;
 import android.provider.MediaStore.Audio.AlbumColumns;
 import android.provider.MediaStore.Audio.AudioColumns;
+import android.support.v4.os.BuildCompat;
 import android.text.TextUtils;
 import android.util.Log;
 import android.util.LongSparseArray;
@@ -337,6 +339,8 @@ public class MusicPlaybackService extends Service {
      */
     public static final int MAX_HISTORY_SIZE = 1000;
 
+    private static final String CHANNEL_NAME = "eleven_playback";
+
     public interface TrackErrorExtra {
         /**
          * Name of the track that was unable to play
@@ -1645,7 +1649,7 @@ public class MusicPlaybackService extends Service {
             mNotificationPostTime = System.currentTimeMillis();
         }
 
-        Notification.Builder builder = new Notification.Builder(this)
+        Notification.Builder builder = new Notification.Builder(this, CHANNEL_NAME)
                 .setSmallIcon(R.drawable.ic_notification)
                 .setLargeIcon(artwork.getBitmap())
                 .setContentIntent(clickIntent)
@@ -1666,6 +1670,24 @@ public class MusicPlaybackService extends Service {
 
         builder.setColor(artwork.getVibrantDarkColor());
 
+        if (BuildCompat.isAtLeastO()) {
+            NotificationChannel channel = mNotificationManager
+                    .getNotificationChannel(CHANNEL_NAME);
+
+            if (channel == null) {
+                String name = getString(R.string.channel_music);
+
+                channel = new NotificationChannel(CHANNEL_NAME, name,
+                        mNotificationManager.IMPORTANCE_DEFAULT);
+                channel.setShowBadge(false);
+                channel.enableVibration(false);
+                channel.setSound(null, null);
+                mNotificationManager.createNotificationChannel(channel);
+            }
+
+            builder.setChannelId(channel.getId());
+        }
+
         return builder.build();
     }
 
-- 
2.17.1

