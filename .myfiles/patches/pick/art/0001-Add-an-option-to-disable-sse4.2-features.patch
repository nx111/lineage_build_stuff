From a590a49a84ea90227a967d2d51f02223db1d5938 Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Fri, 1 Mar 2019 15:30:59 +0100
Subject: [PATCH] Add an option to disable sse4.2 features

* Infra needs that

Change-Id: I5b44ed474738ca842715d6ad46b6e56341838d7a
---
 build/Android.bp | 9 ---------
 build/art.go     | 5 +++++
 2 files changed, 5 insertions(+), 9 deletions(-)

diff --git a/build/Android.bp b/build/Android.bp
index 2a5598fb7a..a981528414 100644
--- a/build/Android.bp
+++ b/build/Android.bp
@@ -92,15 +92,6 @@ art_global_defaults {
                 // Bug: 15446488. We don't omit the frame pointer to work around
                 // clang/libunwind bugs that cause SEGVs in run-test-004-ThreadStress.
                 "-fno-omit-frame-pointer",
-                // The build assumes that all our x86/x86_64 hosts (such as buildbots and developer
-                // desktops) support at least sse4.2/popcount. This firstly implies that the ART
-                // runtime binary itself may exploit these features. Secondly, this implies that
-                // the ART runtime passes these feature flags to dex2oat and JIT by calling the
-                // method InstructionSetFeatures::FromCppDefines(). Since invoking dex2oat directly
-                // does not pick up these flags, cross-compiling from a x86/x86_64 host to a
-                // x86/x86_64 target should not be affected.
-                "-msse4.2",
-                "-mpopcnt",
             ],
         },
     },
diff --git a/build/art.go b/build/art.go
index 59480a0d0f..84c79a3dd2 100644
--- a/build/art.go
+++ b/build/art.go
@@ -168,6 +168,11 @@ func hostFlags(ctx android.BaseContext) []string {
 		cflags = append(cflags, "-DART_ENABLE_ADDRESS_SANITIZER=1")
 	}
 
+	if !envFalse(ctx, "CPU_SSE42") {
+		cflags = append(cflags, "-msse4.2")
+		cflags = append(cflags, "-mpopcnt")
+	}
+
 	return cflags
 }
 
-- 
2.17.1

