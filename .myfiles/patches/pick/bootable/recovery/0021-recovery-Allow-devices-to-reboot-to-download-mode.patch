From 7b4564c0bba1c3e69bc0119c36e4f7d51bc08b28 Mon Sep 17 00:00:00 2001
From: Andreas Blaesius <skate4life@gmx.de>
Date: Sun, 26 Apr 2015 02:28:14 +0200
Subject: [PATCH 21/44] recovery: Allow devices to reboot to download mode

Change-Id: Ib6ccf98ed68efacbb3b8c8238945da60b23a20d7
---
 Android.mk   | 4 ++++
 device.cpp   | 4 ++++
 recovery.cpp | 5 +++++
 3 files changed, 13 insertions(+)

diff --git a/Android.mk b/Android.mk
index 2c333e7b..185a7225 100644
--- a/Android.mk
+++ b/Android.mk
@@ -258,6 +258,10 @@ ifeq ($(AB_OTA_UPDATER),true)
     LOCAL_CFLAGS += -DAB_OTA_UPDATER=1
 endif
 
+ifeq ($(BOARD_HAS_DOWNLOAD_MODE), true)
+    LOCAL_CFLAGS += -DDOWNLOAD_MODE
+endif
+
 LOCAL_MODULE_PATH := $(TARGET_RECOVERY_ROOT_OUT)/sbin
 
 ifeq ($(TARGET_RECOVERY_UI_LIB),)
diff --git a/device.cpp b/device.cpp
index eefd1f0a..7528ced4 100644
--- a/device.cpp
+++ b/device.cpp
@@ -18,7 +18,11 @@
 
 static const char* MENU_ITEMS[] = {
   "Reboot system now",
+#ifdef DOWNLOAD_MODE
+  "Reboot to download mode",
+#else
   "Reboot to bootloader",
+#endif
   "Apply update",
   "Wipe data/factory reset",
 #ifndef AB_OTA_UPDATER
diff --git a/recovery.cpp b/recovery.cpp
index e348bb4e..c377f781 100644
--- a/recovery.cpp
+++ b/recovery.cpp
@@ -1964,8 +1964,13 @@ int main(int argc, char **argv) {
       break;
 
     case Device::REBOOT_BOOTLOADER:
+#ifdef DOWNLOAD_MODE
+      ui->Print("Rebooting to download mode...\n");
+      android::base::SetProperty(ANDROID_RB_PROPERTY, "reboot,download");
+#else
       ui->Print("Rebooting to bootloader...\n");
       android::base::SetProperty(ANDROID_RB_PROPERTY, "reboot,bootloader");
+#endif
       break;
 
     default:
-- 
2.17.1

