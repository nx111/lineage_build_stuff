From 10a7d1548a87635649ab4fadb65f2bbf1c1b9585 Mon Sep 17 00:00:00 2001
From: Tom Marshall <tdm.code@gmail.com>
Date: Mon, 7 Jan 2019 14:21:34 -0800
Subject: [PATCH 08/44] recovery: Enable gunzip/gzip/unzip/zip commands

Change-Id: I938dc855742d4e1a5ba0b09fd74851b0d155f0a1
---
 Android.mk      | 34 +++++++++++++++++++++++++++++++++-
 recovery.cpp    |  4 ++++
 recovery_cmds.h |  3 +++
 3 files changed, 40 insertions(+), 1 deletion(-)

diff --git a/Android.mk b/Android.mk
index ee68e725..4b764e95 100644
--- a/Android.mk
+++ b/Android.mk
@@ -170,6 +170,10 @@ LOCAL_STATIC_LIBRARIES += \
     libsparse \
     libreboot \
     libziparchive \
+    libminipigz_static \
+    libzopfli_static \
+    libminizip_static \
+    libminiunz_static \
     libotautil \
     libmounts \
     libminadbd \
@@ -216,7 +220,11 @@ LOCAL_REQUIRED_MODULES += \
 RECOVERY_TOOLS := \
     reboot \
     setup_adbd \
-    sh
+    sh \
+    gunzip \
+    gzip \
+    unzip \
+    zip
 LOCAL_POST_INSTALL_CMD := $(hide) $(foreach t,$(RECOVERY_TOOLS),ln -sf ${LOCAL_MODULE} $(LOCAL_MODULE_PATH)/$(t);)
 
 include $(BUILD_EXECUTABLE)
@@ -231,6 +239,30 @@ LOCAL_SRC_FILES := etc/mkshrc
 LOCAL_MODULE_STEM := mkshrc
 include $(BUILD_PREBUILT)
 
+# Minizip static library
+include $(CLEAR_VARS)
+LOCAL_MODULE := libminizip_static
+LOCAL_MODULE_TAGS := optional
+LOCAL_CFLAGS := -Dmain=minizip_main -D__ANDROID__ -DIOAPI_NO_64
+LOCAL_C_INCLUDES := external/zlib
+LOCAL_SRC_FILES := \
+    ../../external/zlib/src/contrib/minizip/ioapi.c \
+    ../../external/zlib/src/contrib/minizip/minizip.c \
+    ../../external/zlib/src/contrib/minizip/zip.c
+include $(BUILD_STATIC_LIBRARY)
+
+# Miniunz static library
+include $(CLEAR_VARS)
+LOCAL_MODULE := libminiunz_static
+LOCAL_MODULE_TAGS := optional
+LOCAL_CFLAGS := -Dmain=miniunz_main -D__ANDROID__ -DIOAPI_NO_64
+LOCAL_C_INCLUDES := external/zlib
+LOCAL_SRC_FILES := \
+    ../../external/zlib/src/contrib/minizip/ioapi.c \
+    ../../external/zlib/src/contrib/minizip/miniunz.c \
+    ../../external/zlib/src/contrib/minizip/unzip.c
+include $(BUILD_STATIC_LIBRARY)
+
 # Reboot static library
 include $(CLEAR_VARS)
 LOCAL_MODULE := libreboot
diff --git a/recovery.cpp b/recovery.cpp
index ec2a648f..b42443ea 100644
--- a/recovery.cpp
+++ b/recovery.cpp
@@ -83,6 +83,10 @@ struct recovery_cmd {
 static const struct recovery_cmd recovery_cmds[] = {
   { "reboot",         reboot_main },
   { "poweroff",       reboot_main },
+  { "gunzip",         pigz_main },
+  { "gzip",           pigz_main },
+  { "unzip",          miniunz_main },
+  { "zip",            minizip_main },
   { "sh",             mksh_main },
   { nullptr, nullptr },
 };
diff --git a/recovery_cmds.h b/recovery_cmds.h
index f0e00ca2..b5a8825b 100644
--- a/recovery_cmds.h
+++ b/recovery_cmds.h
@@ -21,6 +21,9 @@
 extern "C" {
 #endif
 
+int pigz_main(int argc, char **argv);
+int miniunz_main(int argc, char **argv);
+int minizip_main(int argc, char **argv);
 int reboot_main(int argc, char **argv);
 int poweroff_main(int argc, char **argv);
 int start_main(int argc, char **argv);
-- 
2.17.1

