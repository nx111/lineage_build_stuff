From a929bede5589190c4dc993e985372532c105f0f8 Mon Sep 17 00:00:00 2001
From: Alessandro Astone <ales.astone@gmail.com>
Date: Tue, 26 Mar 2019 16:58:21 +0100
Subject: [PATCH 52/62] recovery: VolumeManager: support for multiple /data fs
 entries

Change-Id: I0ec2c9f3c44b3aa69e07aa97e45a0ee3214ffd05
---
 volume_manager/VolumeManager.cpp | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/volume_manager/VolumeManager.cpp b/volume_manager/VolumeManager.cpp
index 893aa619..11dc5495 100644
--- a/volume_manager/VolumeManager.cpp
+++ b/volume_manager/VolumeManager.cpp
@@ -20,6 +20,7 @@
 #include <dirent.h>
 #include <fs_mgr.h>
 #include <sys/sysmacros.h>
+#include <blkid/blkid.h>
 
 #define LOG_TAG "VolumeManager"
 
@@ -131,7 +132,10 @@ process_config(VolumeManager *vm, fstab_rec** data_recp)
         }
         else {
             if (!*data_recp && !strcmp(fstab->recs[i].mount_point, "/data")) {
-                *data_recp = &fstab->recs[i];
+                char* detected_fs_type = blkid_get_tag_value(nullptr, "TYPE",
+                                                             fstab->recs[i].blk_device);
+                if (!strcmp(detected_fs_type, fstab->recs[i].fs_type))
+                    *data_recp = &fstab->recs[i];
             }
         }
     }
-- 
2.17.1

