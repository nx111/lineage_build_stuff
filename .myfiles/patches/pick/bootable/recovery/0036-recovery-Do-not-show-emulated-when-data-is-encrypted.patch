From 7d43f7ece3e4697743a130690f19c79bb7772df6 Mon Sep 17 00:00:00 2001
From: Tom Marshall <tdm.code@gmail.com>
Date: Mon, 7 Jan 2019 14:42:42 -0800
Subject: [PATCH 36/44] recovery: Do not show emulated when data is encrypted

Change-Id: I9411159af2b8d83316d548da50ae6d18003415e2
---
 recovery.cpp | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/recovery.cpp b/recovery.cpp
index 855e9466..6c5a6c3e 100644
--- a/recovery.cpp
+++ b/recovery.cpp
@@ -200,6 +200,7 @@ static_assert(kRecoveryApiVersion == RECOVERY_API_VERSION, "Mismatching recovery
 static std::string locale;
 static bool has_cache = false;
 
+static const char* fbe_key_version = "/data/unencrypted/key/version";
 static const char* adb_keys_data = "/data/misc/adb/adb_keys";
 static const char* adb_keys_root = "/adb_keys";
 static const char* time_off_1_data = "/data/time/ats_1";
@@ -212,6 +213,9 @@ std::string stage;
 const char* reason = nullptr;
 struct selabel_handle* sehandle;
 
+bool userdata_mountable = false;
+bool userdata_encrypted = true;
+
 /*
  * The recovery tool communicates with the main system through /cache files.
  *   /cache/recovery/command - INPUT - command line for tool, one arg per line
@@ -1255,6 +1259,11 @@ refresh:
     VolumeManager::Instance()->getVolumeInfo(volumes);
 
     for (auto& vol : volumes) {
+        if (vol.mLabel == "emulated") {
+            if (!userdata_mountable || userdata_encrypted) {
+                continue;
+            }
+        }
         items.push_back(MenuItem("Choose from " + vol.mLabel));
     }
 
@@ -1591,6 +1600,10 @@ static void log_failure_code(ErrorCode code, const char *update_package) {
 
 static void copy_userdata_files() {
   if (ensure_path_mounted("/data") == 0) {
+      userdata_mountable = true;
+      if (access(fbe_key_version, F_OK) != 0) {
+        userdata_encrypted = false;
+      }
     if (access(adb_keys_root, F_OK) != 0) {
       if (access(adb_keys_data, R_OK) == 0) {
         file_copy(adb_keys_data, adb_keys_root);
-- 
2.17.1

