From 384ed0b685466d1b6fb66705f39d363f6d583459 Mon Sep 17 00:00:00 2001
From: Tom Marshall <tdm.code@gmail.com>
Date: Mon, 7 Jan 2019 14:42:42 -0800
Subject: [PATCH 36/50] recovery: Do not show emulated when data is encrypted

Change-Id: I9411159af2b8d83316d548da50ae6d18003415e2
---
 recovery.cpp | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/recovery.cpp b/recovery.cpp
index b847de05..28d2d664 100644
--- a/recovery.cpp
+++ b/recovery.cpp
@@ -200,6 +200,7 @@ static_assert(kRecoveryApiVersion == RECOVERY_API_VERSION, "Mismatching recovery
 static std::string locale;
 static bool has_cache = false;
 
+static const char* fbe_key_version = "/data/unencrypted/key/version";
 static const char* adb_keys_data = "/data/misc/adb/adb_keys";
 static const char* adb_keys_root = "/adb_keys";
 
@@ -209,6 +210,9 @@ std::string stage;
 const char* reason = nullptr;
 struct selabel_handle* sehandle;
 
+bool userdata_mountable = false;
+bool userdata_encrypted = true;
+
 /*
  * The recovery tool communicates with the main system through /cache files.
  *   /cache/recovery/command - INPUT - command line for tool, one arg per line
@@ -1252,6 +1256,11 @@ refresh:
     VolumeManager::Instance()->getVolumeInfo(volumes);
 
     for (auto& vol : volumes) {
+        if (vol.mLabel == "emulated") {
+            if (!userdata_mountable || userdata_encrypted) {
+                continue;
+            }
+        }
         items.push_back(MenuItem("Choose from " + vol.mLabel));
     }
 
@@ -1588,6 +1597,10 @@ static void log_failure_code(ErrorCode code, const char *update_package) {
 
 static void copy_userdata_files() {
   if (ensure_path_mounted("/data") == 0) {
+      userdata_mountable = true;
+      if (access(fbe_key_version, F_OK) != 0) {
+        userdata_encrypted = false;
+      }
     if (access(adb_keys_root, F_OK) != 0) {
       if (access(adb_keys_data, R_OK) == 0) {
         file_copy(adb_keys_data, adb_keys_root);
-- 
2.17.1

