From 9563568c919338e43614c67b8af13542ef97dc14 Mon Sep 17 00:00:00 2001
From: Dan Pasanen <dan.pasanen@gmail.com>
Date: Tue, 4 Apr 2017 13:40:19 -0500
Subject: [PATCH 18/44] recovery: Add wipe system partition option

Change-Id: Id606cef249a7464037443de6265055803c290d82
---
 device.cpp   |  2 ++
 device.h     | 13 +++++++------
 recovery.cpp | 25 +++++++++++++++++++++++++
 3 files changed, 34 insertions(+), 6 deletions(-)

diff --git a/device.cpp b/device.cpp
index 5c34e57c..eefd1f0a 100644
--- a/device.cpp
+++ b/device.cpp
@@ -24,6 +24,7 @@ static const char* MENU_ITEMS[] = {
 #ifndef AB_OTA_UPDATER
   "Wipe cache partition",
 #endif  // !AB_OTA_UPDATER
+  "Wipe system partition",
   "Mount /system",
   "View recovery logs",
   "Run graphics test",
@@ -40,6 +41,7 @@ static const Device::BuiltinAction MENU_ACTIONS[] = {
 #ifndef AB_OTA_UPDATER
   Device::WIPE_CACHE,
 #endif  // !AB_OTA_UPDATER
+  Device::WIPE_SYSTEM,
   Device::MOUNT_SYSTEM,
   Device::VIEW_RECOVERY_LOGS,
   Device::RUN_GRAPHICS_TEST,
diff --git a/device.h b/device.h
index 7d3477cb..aa4bcf0d 100644
--- a/device.h
+++ b/device.h
@@ -61,12 +61,13 @@ class Device {
     // APPLY_ADB_SIDELOAD was 4.
     WIPE_DATA = 5,
     WIPE_CACHE = 6,
-    REBOOT_BOOTLOADER = 7,
-    SHUTDOWN = 8,
-    VIEW_RECOVERY_LOGS = 9,
-    MOUNT_SYSTEM = 10,
-    RUN_GRAPHICS_TEST = 11,
-    RUN_LOCALE_TEST = 12,
+    WIPE_SYSTEM = 7,
+    REBOOT_BOOTLOADER = 8,
+    SHUTDOWN = 9,
+    VIEW_RECOVERY_LOGS = 10,
+    MOUNT_SYSTEM = 11,
+    RUN_GRAPHICS_TEST = 12,
+    RUN_LOCALE_TEST = 13,
   };
 
   // Return the list of menu items (an array of strings, NULL-terminated). The menu_position passed
diff --git a/recovery.cpp b/recovery.cpp
index d9f1afdf..c8e8bd9d 100644
--- a/recovery.cpp
+++ b/recovery.cpp
@@ -939,6 +939,20 @@ static bool wipe_cache(bool should_confirm, Device* device) {
     return success;
 }
 
+static bool ask_to_wipe_system(Device* device) {
+    return yes_no(device, "Wipe system?", "  THIS CAN NOT BE UNDONE!");
+}
+
+// Return true on success.
+static bool wipe_system() {
+    modified_flash = true;
+
+    ui->Print("\n-- Wiping system...\n");
+    bool success = erase_volume("/system");
+    ui->Print("System wipe %s.\n", success ? "complete" : "failed");
+    return success;
+}
+
 // Secure-wipe a given partition. It uses BLKSECDISCARD, if supported. Otherwise, it goes with
 // BLKDISCARD (if device supports BLKDISCARDZEROES) or BLKZEROOUT.
 static bool secure_wipe_partition(const std::string& partition) {
@@ -1314,6 +1328,17 @@ static Device::BuiltinAction prompt_and_wait(Device* device, int status) {
         if (!ui->IsTextVisible()) return Device::NO_ACTION;
         break;
 
+      case Device::WIPE_SYSTEM:
+        if (ui->IsTextVisible()) {
+          if (ask_to_wipe_system(device)) {
+            wipe_system();
+          }
+        } else {
+          wipe_system();
+          return Device::NO_ACTION;
+        }
+        break;
+
       case Device::APPLY_UPDATE:
         {
           status = show_apply_update_menu(device, &should_wipe_cache);
-- 
2.17.1

