From c9e40aed978625cc5920f3fb88306808bca93334 Mon Sep 17 00:00:00 2001
From: Alessandro Astone <ales.astone@gmail.com>
Date: Fri, 29 Mar 2019 16:42:38 +0100
Subject: [PATCH 55/61] recovery: prevent drawing the last item of a menu
 offscreen

Change-Id: If6b5b91cdcc36003a17ed24e58b820d44a810070
---
 screen_ui.cpp | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/screen_ui.cpp b/screen_ui.cpp
index 1a82d055..a1e23eba 100644
--- a/screen_ui.cpp
+++ b/screen_ui.cpp
@@ -591,6 +591,8 @@ void ScreenRecoveryUI::draw_header_locked(int& y) {
 void ScreenRecoveryUI::draw_text_menu_locked(int& y) {
   static constexpr int kMenuIndent = 4;
   int x = kMarginWidth + kMenuIndent;
+  // An item should not be displayed if it's shown height would be less than 75% of its true height
+  static const int kMinItemHeight = MenuItemHeight() * 3 / 4;
 
   draw_statusbar_locked();
   draw_header_locked(y);
@@ -606,7 +608,7 @@ void ScreenRecoveryUI::draw_text_menu_locked(int& y) {
 
   menu_start_y_ = y;
   int i;
-  for (i = menu_show_start; i < (int)menu_items_.size() && y < gr_fb_height(); ++i) {
+  for (i = menu_show_start; i < (int)menu_items_.size() && y + kMinItemHeight < gr_fb_height(); ++i) {
     const ScreenMenuItem& item = menu_items_.at(i);
     if (i == menu_sel) {
       SetColor(MENU_SEL_FG);
-- 
2.17.1

