From cfdc1cee6ebc44511fd9d4370c7c6df1da0e4234 Mon Sep 17 00:00:00 2001
From: Paul Keith <javelinanddart@gmail.com>
Date: Mon, 4 Feb 2019 09:33:05 -0600
Subject: [PATCH 1/5] livedisplay: Set binder buffer limit to 8KB for ARM32
 devices

Change-Id: Ibf2e166d0ca4261f3f36a1a9c89ede2f4346df8b
---
 legacymm/Android.bp  | 6 ++++++
 legacymm/service.cpp | 4 ++++
 sdm/Android.bp       | 6 ++++++
 sdm/service.cpp      | 4 ++++
 4 files changed, 20 insertions(+)

diff --git a/legacymm/Android.bp b/legacymm/Android.bp
index 452ca56..1d96bc4 100644
--- a/legacymm/Android.bp
+++ b/legacymm/Android.bp
@@ -29,7 +29,13 @@ cc_binary {
         "libdl",
         "libhidlbase",
         "libhidltransport",
+        "libhwbinder",
         "libutils",
         "vendor.lineage.livedisplay@2.0",
     ],
+    arch: {
+        arm: {
+            cflags: ["-DARCH_ARM_32"],
+        },
+    },
 }
diff --git a/legacymm/service.cpp b/legacymm/service.cpp
index e668699..9bf494c 100644
--- a/legacymm/service.cpp
+++ b/legacymm/service.cpp
@@ -49,6 +49,10 @@ int main() {
 
     status_t status = OK;
 
+#ifdef ARCH_ARM_32
+    android::hardware::ProcessState::initWithMmapSize((size_t)8192);
+#endif
+
     LOG(INFO) << "LiveDisplay HAL service is starting.";
 
     libHandle = dlopen(MM_DISP_LIB, RTLD_NOW);
diff --git a/sdm/Android.bp b/sdm/Android.bp
index 173dc4e..937ab3d 100644
--- a/sdm/Android.bp
+++ b/sdm/Android.bp
@@ -30,9 +30,15 @@ cc_defaults {
         "libdl",
         "libhidlbase",
         "libhidltransport",
+        "libhwbinder",
         "libutils",
         "vendor.lineage.livedisplay@2.0",
     ],
+    arch: {
+        arm: {
+            cflags: ["-DARCH_ARM_32"],
+        },
+    },
 }
 
 cc_binary {
diff --git a/sdm/service.cpp b/sdm/service.cpp
index ac7ee5c..b5699c5 100644
--- a/sdm/service.cpp
+++ b/sdm/service.cpp
@@ -69,6 +69,10 @@ int main() {
     android::ProcessState::initWithDriver("/dev/vndbinder");
 #endif
 
+#ifdef ARCH_ARM_32
+    android::hardware::ProcessState::initWithMmapSize((size_t)8192);
+#endif
+
     LOG(INFO) << "LiveDisplay HAL service is starting.";
 
     libHandle = dlopen(SDM_DISP_LIB, RTLD_NOW);
-- 
2.17.1

