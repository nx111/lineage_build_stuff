From 465e5b3f71679077215462047cc59a76983c76b6 Mon Sep 17 00:00:00 2001
From: vhunac <vhunac@codeaurora.org>
Date: Fri, 16 Feb 2018 12:24:32 +0530
Subject: [PATCH 07/15] power: Turn on/off display

PowerHAL writes to a sysfs node when it gets display on/off
notification.

Change-Id: I8c3437908f992aec23336ea104c6ac091a961205
---
 power-8953.c | 44 ++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 44 insertions(+)

diff --git a/power-8953.c b/power-8953.c
index 5dacc03..05511a3 100644
--- a/power-8953.c
+++ b/power-8953.c
@@ -50,6 +50,9 @@
 #include "performance.h"
 #include "power-common.h"
 
+static int display_fd;
+#define SYS_DISPLAY_PWR "/sys/kernel/hbtp/display_pwr"
+
 #define CHECK_HANDLE(x) ((x)>0)
 #define NUM_PERF_MODES  3
 
@@ -374,6 +377,13 @@ int power_hint_override(power_hint_t hint, void *data)
 int set_interactive_override(int on)
 {
     char governor[80];
+    int rc = 0;
+
+    static const char *display_on = "1";
+    static const char *display_off = "0";
+    char err_buf[80];
+    static int init_interactive_hint = 0;
+    static int set_i_count = 0;
 
     if (get_scaling_governor_check_cores(governor, sizeof(governor), CPU0) == -1) {
         if (get_scaling_governor_check_cores(governor, sizeof(governor), CPU1) == -1) {
@@ -401,5 +411,39 @@ int set_interactive_override(int on)
             undo_hint_action(DISPLAY_STATE_HINT_ID);
         }
     }
+
+    set_i_count ++;
+    ALOGI("Got set_interactive hint on= %d, count= %d\n", on, set_i_count);
+
+    if (init_interactive_hint == 0)
+    {
+        //First time the display is turned off
+        display_fd = TEMP_FAILURE_RETRY(open(SYS_DISPLAY_PWR, O_RDWR));
+        if (display_fd < 0) {
+            strerror_r(errno,err_buf,sizeof(err_buf));
+            ALOGE("Error opening %s: %s\n", SYS_DISPLAY_PWR, err_buf);
+            return HINT_HANDLED;
+        }
+        else
+            init_interactive_hint = 1;
+    }
+    else
+        if (!on ) {
+            /* Display off. */
+            rc = TEMP_FAILURE_RETRY(write(display_fd, display_off, strlen(display_off)));
+            if (rc < 0) {
+                strerror_r(errno,err_buf,sizeof(err_buf));
+                ALOGE("Error writing %s to  %s: %s\n", display_off, SYS_DISPLAY_PWR, err_buf);
+            }
+        }
+        else {
+            /* Display on */
+            rc = TEMP_FAILURE_RETRY(write(display_fd, display_on, strlen(display_on)));
+            if (rc < 0) {
+                strerror_r(errno,err_buf,sizeof(err_buf));
+                ALOGE("Error writing %s to  %s: %s\n", display_on, SYS_DISPLAY_PWR, err_buf);
+            }
+        }
+
     return HINT_HANDLED;
 }
-- 
2.17.1

