From 943748360d9044dbc36033476caf9a8e8a873462 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?eray=20or=C3=A7unus?= <erayorcunus@gmail.com>
Date: Fri, 26 Apr 2019 00:15:30 +0300
Subject: [PATCH 28/43] SystemUI: Fix several layout bugs
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

* QSDetail and QSCustomize panels' clippers starts after the black
  header, but the ripple animation coords were wrong.

* QSDetail and QSCustomize use a transparent view to let QS header
  be seen. Header's height changes with orientation, but QSDetail
  and QSCustomize do nothing about it.
  As a result, there were gaps or blocked views.

Change-Id: I5cefad14b519be99adcf5c913e96385d45b8fb17
Signed-off-by: eray or√ßunus <erayorcunus@gmail.com>
---
 .../SystemUI/res/layout/qs_customize_panel_content.xml    | 1 +
 packages/SystemUI/res/layout/qs_detail.xml                | 1 +
 .../SystemUI/src/com/android/systemui/qs/QSDetail.java    | 8 ++++++++
 .../SystemUI/src/com/android/systemui/qs/QSPanel.java     | 5 +++--
 .../com/android/systemui/qs/customize/QSCustomizer.java   | 8 ++++++++
 5 files changed, 21 insertions(+), 2 deletions(-)

diff --git a/packages/SystemUI/res/layout/qs_customize_panel_content.xml b/packages/SystemUI/res/layout/qs_customize_panel_content.xml
index d70a37ae15b..9082f926bcd 100644
--- a/packages/SystemUI/res/layout/qs_customize_panel_content.xml
+++ b/packages/SystemUI/res/layout/qs_customize_panel_content.xml
@@ -17,6 +17,7 @@
 
 <merge xmlns:android="http://schemas.android.com/apk/res/android">->
     <View
+        android:id="@+id/qs_customizer_top_space"
         android:layout_width="match_parent"
         android:layout_height="@*android:dimen/quick_qs_offset_height"
         android:background="@android:color/transparent" />
diff --git a/packages/SystemUI/res/layout/qs_detail.xml b/packages/SystemUI/res/layout/qs_detail.xml
index dbe769017c8..facb40b9fe5 100644
--- a/packages/SystemUI/res/layout/qs_detail.xml
+++ b/packages/SystemUI/res/layout/qs_detail.xml
@@ -26,6 +26,7 @@
     android:elevation="4dp" >
 
     <View
+        android:id="@+id/qs_detail_top_space"
         android:layout_width="match_parent"
         android:layout_height="@*android:dimen/quick_qs_offset_height"
         android:background="@android:color/transparent" />
diff --git a/packages/SystemUI/src/com/android/systemui/qs/QSDetail.java b/packages/SystemUI/src/com/android/systemui/qs/QSDetail.java
index 16a2bb8f6ab..8222375f3bd 100644
--- a/packages/SystemUI/src/com/android/systemui/qs/QSDetail.java
+++ b/packages/SystemUI/src/com/android/systemui/qs/QSDetail.java
@@ -61,6 +61,7 @@ public class QSDetail extends LinearLayout {
     protected TextView mQsDetailHeaderTitle;
     protected Switch mQsDetailHeaderSwitch;
     protected ImageView mQsDetailHeaderProgress;
+    protected View mQsDetailTopSpace;
 
     protected QSTileHost mHost;
 
@@ -88,6 +89,12 @@ public class QSDetail extends LinearLayout {
         for (int i = 0; i < mDetailViews.size(); i++) {
             mDetailViews.valueAt(i).dispatchConfigurationChanged(newConfig);
         }
+
+        // Update top space height in orientation change
+        mQsDetailTopSpace.getLayoutParams().height =
+                mContext.getResources().getDimensionPixelSize(
+                        com.android.internal.R.dimen.quick_qs_offset_height);
+        mQsDetailTopSpace.setLayoutParams(mQsDetailTopSpace.getLayoutParams());
     }
 
     @Override
@@ -101,6 +108,7 @@ public class QSDetail extends LinearLayout {
         mQsDetailHeaderTitle = (TextView) mQsDetailHeader.findViewById(android.R.id.title);
         mQsDetailHeaderSwitch = (Switch) mQsDetailHeader.findViewById(android.R.id.toggle);
         mQsDetailHeaderProgress = findViewById(R.id.qs_detail_header_progress);
+        mQsDetailTopSpace = findViewById(R.id.qs_detail_top_space);
 
         updateDetailText();
 
diff --git a/packages/SystemUI/src/com/android/systemui/qs/QSPanel.java b/packages/SystemUI/src/com/android/systemui/qs/QSPanel.java
index 0d5976c3794..c531a2c2da9 100644
--- a/packages/SystemUI/src/com/android/systemui/qs/QSPanel.java
+++ b/packages/SystemUI/src/com/android/systemui/qs/QSPanel.java
@@ -499,7 +499,8 @@ public class QSPanel extends LinearLayout implements Tunable, Callback, Brightne
                         int[] loc = new int[2];
                         v.getLocationInWindow(loc);
                         int x = loc[0] + v.getWidth() / 2;
-                        int y = loc[1] + v.getHeight() / 2;
+                        // we subtract getTop, because Pie clipper starts after black area
+                        int y = loc[1] + v.getHeight() / 2 - getTop();
                         mCustomizePanel.show(x, y);
                     }
                 }
@@ -544,7 +545,7 @@ public class QSPanel extends LinearLayout implements Tunable, Callback, Brightne
         }
         r.tile.setDetailListening(show);
         int x = r.tileView.getLeft() + r.tileView.getWidth() / 2;
-        int y = r.tileView.getDetailY() + mTileLayout.getOffsetTop(r) + getTop();
+        int y = r.tileView.getDetailY() + mTileLayout.getOffsetTop(r);
         handleShowDetailImpl(r, show, x, y);
     }
 
diff --git a/packages/SystemUI/src/com/android/systemui/qs/customize/QSCustomizer.java b/packages/SystemUI/src/com/android/systemui/qs/customize/QSCustomizer.java
index 394c3225bce..bfa54820d65 100644
--- a/packages/SystemUI/src/com/android/systemui/qs/customize/QSCustomizer.java
+++ b/packages/SystemUI/src/com/android/systemui/qs/customize/QSCustomizer.java
@@ -67,6 +67,7 @@ public class QSCustomizer extends LinearLayout implements OnMenuItemClickListene
     private final QSDetailClipper mClipper;
     private final LightBarController mLightBarController;
     private final TileQueryHelper mTileQueryHelper;
+    private final View mQsCustomizerTopSpace;
 
     private boolean isShown;
     private QSTileHost mHost;
@@ -119,12 +120,19 @@ public class QSCustomizer extends LinearLayout implements OnMenuItemClickListene
         mRecyclerView.setItemAnimator(animator);
         mLightBarController = Dependency.get(LightBarController.class);
         updateNavBackDrop(getResources().getConfiguration());
+        mQsCustomizerTopSpace = findViewById(R.id.qs_customizer_top_space);
     }
 
     @Override
     protected void onConfigurationChanged(Configuration newConfig) {
         super.onConfigurationChanged(newConfig);
         updateNavBackDrop(newConfig);
+
+        // Update top space height in orientation change
+        mQsCustomizerTopSpace.getLayoutParams().height =
+                mContext.getResources().getDimensionPixelSize(
+                        com.android.internal.R.dimen.quick_qs_offset_height);
+        mQsCustomizerTopSpace.setLayoutParams(mQsCustomizerTopSpace.getLayoutParams());
     }
 
     private void updateNavBackDrop(Configuration newConfig) {
-- 
2.17.1

