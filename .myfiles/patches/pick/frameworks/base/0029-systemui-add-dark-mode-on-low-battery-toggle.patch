From d5b10058739f1125403d7c9403dfe57c81efd648 Mon Sep 17 00:00:00 2001
From: Joey <joey@lineageos.org>
Date: Tue, 1 Jan 2019 21:59:36 +0100
Subject: [PATCH 29/41] systemui: add dark mode on low battery toggle

Change-Id: I6cc6a5197f6daeeb10bdf7294d6b20583496dc95
Signed-off-by: Joey <joey@lineageos.org>
---
 .../systemui/statusbar/phone/StatusBar.java   | 21 ++++++++++++++-----
 1 file changed, 16 insertions(+), 5 deletions(-)

diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java
index e30e2bae1c4..384f1f931ef 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java
@@ -356,7 +356,7 @@ public class StatusBar extends SystemUI implements DemoMode, TunerService.Tunabl
     private static final boolean DARK_THEME_IN_NIGHT_MODE = true;
 
     /** Whether to switch the device into night mode in battery saver. */
-    private static final boolean NIGHT_MODE_IN_BATTERY_SAVER = true;
+    private static final boolean NIGHT_MODE_IN_BATTERY_SAVER = false;
 
     /**
      * Never let the alpha become zero for surfaces that draw with SRC - otherwise the RenderNode
@@ -1021,6 +1021,7 @@ public class StatusBar extends SystemUI implements DemoMode, TunerService.Tunabl
                 if (mDozeServiceHost != null) {
                     mDozeServiceHost.firePowerSaveChanged(isPowerSave);
                 }
+                updateTheme();
                 if (NIGHT_MODE_IN_BATTERY_SAVER) {
                     mContext.getSystemService(UiModeManager.class).setNightMode(
                         isPowerSave ? UiModeManager.MODE_NIGHT_YES : UiModeManager.MODE_NIGHT_NO);
@@ -2220,6 +2221,11 @@ public class StatusBar extends SystemUI implements DemoMode, TunerService.Tunabl
                 StyleInterface.OVERLAY_DARK_DEFAULT);
     }
 
+    private boolean wantsDarkOnLowBattery() {
+        return LineageSettings.System.getInt(mContext.getContentResolver(),
+                LineageSettings.System.BERRY_DARK_ON_LOW_BATTERY, 0) == 1;
+    }
+
     @Nullable
     public View getAmbientIndicationContainer() {
         return mAmbientIndicationContainer;
@@ -4135,10 +4141,12 @@ public class StatusBar extends SystemUI implements DemoMode, TunerService.Tunabl
                 .getWallpaperColors(WallpaperManager.FLAG_SYSTEM);
         final boolean wallpaperWantsDarkTheme = systemColors != null
                 && (systemColors.getColorHints() & WallpaperColors.HINT_SUPPORTS_DARK_THEME) != 0;
+        /*
         final Configuration config = mContext.getResources().getConfiguration();
         final boolean nightModeWantsDarkTheme = DARK_THEME_IN_NIGHT_MODE
                 && (config.uiMode & Configuration.UI_MODE_NIGHT_MASK)
                     == Configuration.UI_MODE_NIGHT_YES;
+        */
         final boolean useDarkTheme;
 
         switch (globalStyleSetting) {
@@ -4152,21 +4160,24 @@ public class StatusBar extends SystemUI implements DemoMode, TunerService.Tunabl
                 useDarkTheme = true;
                 break;
             default:
-                useDarkTheme = wallpaperWantsDarkTheme || nightModeWantsDarkTheme;
+                useDarkTheme = wallpaperWantsDarkTheme;
                 break;
         }
 
-        if (isUsingDarkTheme() != useDarkTheme) {
+        final boolean darkThemeEnabled = useDarkTheme ||
+                (mBatteryController.isPowerSave() && wantsDarkOnLowBattery());
+
+        if (isUsingDarkTheme() != darkThemeEnabled) {
             mUiOffloadThread.submit(() -> {
                 try {
                     mOverlayManager.setEnabled(getDarkOverlay(),
-                            useDarkTheme, mLockscreenUserManager.getCurrentUserId());
+                            darkThemeEnabled, mLockscreenUserManager.getCurrentUserId());
                 } catch (RemoteException e) {
                     Log.w(TAG, "Can't change theme", e);
                 }
 
                 if (mUiModeManager != null) {
-                    mUiModeManager.setNightMode(useDarkTheme ?
+                    mUiModeManager.setNightMode(darkThemeEnabled ?
                             UiModeManager.MODE_NIGHT_YES : UiModeManager.MODE_NIGHT_NO);
                 }
             });
-- 
2.17.1

