From 1d8fcc0d79455ae5b6b977177ee7071214ecea9f Mon Sep 17 00:00:00 2001
From: Joey <joey@lineageos.org>
Date: Mon, 30 Jul 2018 11:55:29 +0200
Subject: [PATCH 23/35] SettingsLib: add action callbacks to
 CustomDialogPreferences

Change-Id: I256b10b2c4057910cfd24dad27a6f5a628c1c279
Signed-off-by: Joey <joey@lineageos.org>
---
 .../settingslib/CustomDialogPreference.java   | 45 +++++++++++++++++++
 1 file changed, 45 insertions(+)

diff --git a/packages/SettingsLib/src/com/android/settingslib/CustomDialogPreference.java b/packages/SettingsLib/src/com/android/settingslib/CustomDialogPreference.java
index 95a8f1d9782..bfcbd55c6b6 100644
--- a/packages/SettingsLib/src/com/android/settingslib/CustomDialogPreference.java
+++ b/packages/SettingsLib/src/com/android/settingslib/CustomDialogPreference.java
@@ -80,6 +80,10 @@ public class CustomDialogPreference extends DialogPreference {
         return mOnShowListener;
     }
 
+    protected boolean onDismissDialog(DialogInterface dialog, int which) {
+        return true;
+    }
+
     public static class CustomPreferenceDialogFragment extends PreferenceDialogFragment {
 
         public static CustomPreferenceDialogFragment newInstance(String key) {
@@ -94,6 +98,47 @@ public class CustomDialogPreference extends DialogPreference {
             return (CustomDialogPreference) getPreference();
         }
 
+        private class OnDismissListener implements View.OnClickListener {
+            private final DialogInterface mDialog;
+            private final int mWhich;
+
+            public OnDismissListener(DialogInterface dialog, int which) {
+                mDialog = dialog;
+                mWhich = which;
+            }
+
+            @Override
+            public void onClick(View view) {
+                CustomPreferenceDialogFragment.this.onClick(mDialog, mWhich);
+                if (getCustomizablePreference().onDismissDialog(mDialog, mWhich)) {
+                    mDialog.dismiss();
+                }
+            }
+        }
+
+        @Override
+        public void onStart() {
+            super.onStart();
+
+            if (!(getDialog() instanceof AlertDialog)) {
+                return;
+            }
+
+            AlertDialog dialog = (AlertDialog) getDialog();
+            if (dialog.getButton(Dialog.BUTTON_NEUTRAL) != null) {
+                dialog.getButton(Dialog.BUTTON_NEUTRAL).setOnClickListener(
+                        new OnDismissListener(dialog, Dialog.BUTTON_NEUTRAL));
+            }
+            if (dialog.getButton(Dialog.BUTTON_POSITIVE) != null) {
+                dialog.getButton(Dialog.BUTTON_POSITIVE).setOnClickListener(
+                        new OnDismissListener(dialog, Dialog.BUTTON_POSITIVE));
+            }
+            if (dialog.getButton(Dialog.BUTTON_NEGATIVE) != null) {
+                dialog.getButton(Dialog.BUTTON_NEGATIVE).setOnClickListener(
+                        new OnDismissListener(dialog, Dialog.BUTTON_NEGATIVE));
+            }
+        }
+
         @Override
         protected void onPrepareDialogBuilder(AlertDialog.Builder builder) {
             super.onPrepareDialogBuilder(builder);
-- 
2.17.1

